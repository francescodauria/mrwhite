<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mr. White Fixed</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #00e676; --secondary: #2979ff; --danger: #ff5252; --bg: #121212; --surface: #1e1e1e; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; text-align: center; padding-bottom: 60px; }
        .card { background: var(--surface); padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid #333; }
        h1, h2 { margin-top: 0; }
        .accent { color: var(--primary); }
        .white-role { color: var(--danger); }
        .under-role { color: var(--secondary); }
        input { box-sizing: border-box; width: 100%; padding: 15px; margin: 8px 0; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 10px; font-size: 18px; text-align: center; }
        button { width: 100%; padding: 16px; margin-top: 10px; border-radius: 10px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-host { background: var(--primary); color: #000; }
        .btn-join { background: var(--secondary); color: white; }
        .btn-vote { background: #333; border: 1px solid #555; color: white; margin-bottom: 8px; text-align: left; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        .status-bar { padding: 8px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem; }
        .st-alive { background: rgba(0, 230, 118, 0.2); color: var(--primary); border: 1px solid var(--primary); }
        .st-dead { background: rgba(255, 82, 82, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .counter-box { display: flex; justify-content: space-between; align-items: center; background: #2c2c2c; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .counter-btn { width: 40px; height: 40px; margin: 0; padding: 0; font-size: 24px; line-height: 1; }
        .big-word { font-size: 2.2rem; font-weight: 800; color: var(--primary); margin: 20px 0; padding: 20px; border: 2px dashed #444; border-radius: 10px; background: #1a1a1a; word-break: break-word;}
        .win-banner { background: var(--primary); color: black; padding: 20px; margin: -20px -20px 20px -20px; }
        .lose-banner { background: var(--danger); color: white; padding: 20px; margin: -20px -20px 20px -20px; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; }
        .player-list li { background: #252525; margin: 5px 0; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #444; }
        .player-list li.me { border-left-color: var(--primary); }
        .dead-player { text-decoration: line-through; opacity: 0.5; }
    </style>
</head>
<body>

<div class="container" style="max-width: 500px; margin: 0 auto;">
    <h1>üïµÔ∏è Secret Roles</h1>

    <div id="view-login" class="card">
        <h3>Chi sei?</h3>
        <input type="text" id="nickname" placeholder="Il tuo nome">
        <input type="text" id="roomName" placeholder="Nome Stanza (es. ROMA)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="initHost()" class="btn-host">Crea</button>
            <button onclick="initJoin()" class="btn-join">Entra</button>
        </div>
        <p id="connStatus" style="color:#888; font-size:0.9em; margin-top:10px;"></p>
    </div>

    <div id="view-lobby" class="card hidden">
        <h2>Stanza: <span id="lobbyRoomName" class="accent"></span></h2>
        <div id="hostConfig" class="hidden" style="margin: 15px 0;">
            <div class="counter-box">
                <span>üïµÔ∏è Undercover</span>
                <div style="display:flex; gap:10px;"><button class="counter-btn" onclick="adjustRole('undercover', -1)">-</button><span id="count-undercover" style="font-size:20px; font-weight:bold; width:30px;">1</span><button class="counter-btn" onclick="adjustRole('undercover', 1)">+</button></div>
            </div>
            <div class="counter-box">
                <span>üè≥Ô∏è Mr. White</span>
                <div style="display:flex; gap:10px;"><button class="counter-btn" onclick="adjustRole('mrwhite', -1)">-</button><span id="count-mrwhite" style="font-size:20px; font-weight:bold; width:30px;">0</span><button class="counter-btn" onclick="adjustRole('mrwhite', 1)">+</button></div>
            </div>
        </div>
        <p>Giocatori: <span id="playerCount">0</span></p>
        <ul id="lobbyList" class="player-list" style="padding:0; list-style:none;"></ul>
        <div id="hostControls" class="hidden"><button onclick="startGame()" class="btn-host">üöÄ INIZIA PARTITA</button></div>
        <p id="waitingMsg" class="hidden">In attesa dell'Host...</p>
    </div>

    <div id="view-game" class="card hidden">
        <div id="gameStatusHeader" class="status-bar st-alive">üü¢ SEI VIVO</div>
        <h2>Tocca a te!</h2>
        <p>Parola Segreta:</p>
        <div id="myWord" class="big-word">...</div>
        <h3 id="roleTitle">...</h3>
        <p id="roleDesc" style="color:#aaa; font-size: 0.9rem;">...</p>
        <button onclick="goToVote()" class="btn-join">Vai al Voto</button>
    </div>

    <div id="view-vote" class="card hidden">
        <div id="voteStatusHeader" class="status-bar st-alive">üü¢ VOTAZIONE</div>
        <h2>Chi vuoi eliminare?</h2>
        <div id="deadMessage" class="hidden" style="color:var(--danger); border:1px solid var(--danger); padding:10px; border-radius:10px; margin-bottom:10px;">‚ò†Ô∏è SEI MORTO (Spettatore)</div>
        <div id="voteList"></div>
    </div>

    <div id="view-result" class="card hidden" style="padding-top:0;">
        <div id="personalResultBanner" class="win-banner"><h1>VITTORIA</h1><p>...</p></div>
        <h3 id="teamWinnerTitle" style="margin-top:20px;">...</h3>
        <p id="resMsg" style="color:#ccc;">...</p>
        
        <div id="mrWhiteChance" class="hidden" style="background:#330000; padding:15px; border-radius:8px; border:1px solid red; margin-top:20px;">
            <h3 style="color:red; margin-top:0;">üò± Mr. White Preso!</h3>
            <p>Se indovina la parola, ruba la vittoria!</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="finishGame('IMPOSTORS', 'Mr. White ha indovinato!')" style="background:red; color:white; margin:0;">Ha Indovinato</button>
                <button onclick="mrWhiteFailedGuess()" style="background:#444; margin:0;">Ha Sbagliato</button>
            </div>
        </div>

        <div id="resDetails" style="text-align:left; background:#222; padding:10px; border-radius:8px; margin-top:20px;"></div>
        <button onclick="resetGame()" class="btn-host">Nuova Partita</button>
    </div>
</div>
<div id="toast" class="toast">Msg</div>

<script>
    const APP_ID = "mrwhite_fixed_v4_"; 
    const wordsDB = [["Pizza", "Pasta"], ["Cane", "Gatto"], ["Sole", "Luna"], ["Vino", "Birra"], ["Mare", "Lago"], ["Apple", "Samsung"], ["T√®", "Caff√®"], ["Calcio", "Basket"], ["Estate", "Inverno"], ["Ferrari", "Lamborghini"]];
    
    let peer, conn, myId, myName, isHost = false, connections = [];
    let config = { undercover: 1, mrwhite: 0 };
    let gameState = { players: [], phase: 'lobby', wordCiv: '', wordUnd: '' };

    function getCleanId() { const v=document.getElementById('roomName').value; return v ? APP_ID+v.trim().toLowerCase().replace(/[^a-z0-9]/g,'') : null; }
    
    // --- CONNESSIONE ---
    function initHost() {
        const rid = getCleanId(); myName = document.getElementById('nickname').value;
        if(!myName || !rid) return showToast("Mancano dati");
        document.getElementById('connStatus').innerText = "Creo stanza...";
        peer = new Peer(rid);
        peer.on('open', id => { isHost=true; myId=id; addPlayer(id, myName); showLobby(); document.getElementById('hostConfig').classList.remove('hidden'); document.getElementById('hostControls').classList.remove('hidden'); });
        peer.on('error', e => alert("Errore: Stanza occupata o rete."));
        peer.on('connection', c => { connections.push(c); c.on('data', d => handleHost(d, c.peer)); c.on('close', ()=>removePlayer(c.peer)); });
    }

    function initJoin() {
        const rid = getCleanId(); myName = document.getElementById('nickname').value;
        if(!myName || !rid) return showToast("Mancano dati");
        document.getElementById('connStatus').innerText = "Connessione...";
        peer = new Peer();
        peer.on('open', id => { myId=id; conn = peer.connect(rid);
            conn.on('open', () => { conn.send({t:'JOIN', n:myName}); showLobby(); document.getElementById('waitingMsg').classList.remove('hidden'); });
            conn.on('data', d => handleClient(d));
            conn.on('close', ()=> { alert("Host disconnesso"); location.reload(); });
        });
    }

    // --- LOGICA ---
    function handleHost(d, sid) {
        if(d.t==='JOIN') { addPlayer(sid, d.n); sync(); }
        if(d.t==='VOTE') { 
            const p = gameState.players.find(x=>x.id===d.target);
            if(p) p.votes++;
            checkRoundEnd();
        }
    }
    function handleClient(d) {
        if(d.t==='SYNC') { gameState=d.state; renderLobbyList(); }
        if(d.t==='START') { gameState=d.state; renderGame(); }
        if(d.t==='VOTE_OPEN') { gameState=d.state; renderVote(); }
        if(d.t==='OVER') { renderResult(d.winTeam, d.msg, d.mwCaught); }
    }

    function addPlayer(id, name) { if(!gameState.players.find(p=>p.id===id)) gameState.players.push({id, name, alive:true, votes:0}); sync(); }
    function removePlayer(id) { gameState.players = gameState.players.filter(p=>p.id!==id); sync(); renderLobbyList(); }
    function sync() { if(isHost) connections.forEach(c=>c.send({t:'SYNC', state:gameState})); renderLobbyList(); }
    function adjustRole(r, d) { config[r] = Math.max(0, config[r]+d); document.getElementById('count-'+r).innerText = config[r]; }

    function startGame() {
        if(gameState.players.length < 3) return showToast("Minimo 3 giocatori");
        const totBad = config.undercover + config.mrwhite;
        if(totBad === 0 || totBad >= gameState.players.length) return showToast("Configurazione ruoli non valida");

        const pair = wordsDB[Math.floor(Math.random()*wordsDB.length)];
        gameState.wordCiv=pair[0]; gameState.wordUnd=pair[1];

        let deck = Array(config.undercover).fill('undercover').concat(Array(config.mrwhite).fill('mrwhite'));
        while(deck.length < gameState.players.length) deck.push('civil');
        deck = deck.sort(() => Math.random() - 0.5);

        gameState.players.forEach((p, i) => {
            p.role = deck[i]; p.alive=true; p.votes=0;
            p.word = (p.role==='civil') ? gameState.wordCiv : (p.role==='undercover' ? gameState.wordUnd : "???");
        });

        renderGame();
        connections.forEach(c => c.send({t:'START', state:gameState}));
    }

    function checkRoundEnd() {
        const living = gameState.players.filter(p=>p.alive).length;
        const votes = gameState.players.reduce((a,b)=>a+b.votes, 0);
        if(votes >= living) evaluateVotes();
    }

    function evaluateVotes() {
        let max=0, candidates=[];
        gameState.players.forEach(p => { if(p.votes>max){max=p.votes; candidates=[p];} else if(p.votes===max) candidates.push(p); });
        gameState.players.forEach(p=>p.votes=0); // Reset voti

        if(candidates.length !== 1) { // Pareggio
            connections.forEach(c => c.send({t:'VOTE_OPEN', state:gameState}));
            renderVote(); showToast("Pareggio! Si rivota.");
            return;
        }

        const elim = candidates[0];
        elim.alive = false;

        // CHECK SPECIFICO: Se √® Mr White, diamo la chance
        if(elim.role === 'mrwhite') {
            // Non finiamo ancora il gioco, l'host decide
            renderResult('PENDING', `Mr. White (${elim.name}) preso! Deve indovinare.`, true);
            connections.forEach(c => c.send({t:'OVER', winTeam:'PENDING', msg:`Mr. White (${elim.name}) preso! Deve indovinare.`}));
            return;
        }

        checkWinCondition(`${elim.name} eliminato (${elim.role})`);
    }

    // Funzione chiamata se Mr White sbaglia parola
    function mrWhiteFailedGuess() {
        checkWinCondition("Mr. White ha sbagliato la parola!");
    }

    function checkWinCondition(lastActionMsg) {
        const aliveBad = gameState.players.filter(p => p.alive && p.role!=='civil').length;
        const aliveGood = gameState.players.filter(p => p.alive && p.role==='civil').length;
        const totalAlive = aliveBad + aliveGood;

        // 1. Tutti i cattivi morti -> Vincono Civili
        if(aliveBad === 0) return finishGame('CIVILS', "Tutti gli intrusi eliminati!");

        // 2. Parit√† numerica o solo 2 giocatori rimasti -> Vincono Impostori
        // (Se siamo 1vs1 o 2vs2, i civili non possono pi√π vincere il voto)
        if(aliveBad >= aliveGood || totalAlive <= 2) {
            return finishGame('IMPOSTORS', "Gli intrusi hanno la maggioranza (o stallo 1vs1)!");
        }

        // 3. Il gioco continua
        connections.forEach(c => c.send({t:'VOTE_OPEN', state:gameState}));
        renderVote(); showToast(lastActionMsg);
    }

    function finishGame(team, msg) {
        renderResult(team, msg, false);
        connections.forEach(c => c.send({t:'OVER', winTeam:team, msg:msg}));
    }

    // --- UI ---
    function switchView(id) { document.querySelectorAll('.card').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function showLobby() { switchView('view-lobby'); document.getElementById('lobbyRoomName').innerText = document.getElementById('roomName').value; renderLobbyList(); }
    
    function renderLobbyList() {
        const l = document.getElementById('lobbyList'); l.innerHTML='';
        gameState.players.forEach(p => {
            l.innerHTML += `<li class="${p.id===myId?'me':''} ${!p.alive?'dead-player':''}"><span>${p.name} ${!p.alive?'üíÄ':''}</span></li>`;
        });
        document.getElementById('playerCount').innerText=gameState.players.length;
    }

    function renderGame() {
        switchView('view-game');
        const me = gameState.players.find(p=>p.id===myId);
        document.getElementById('myWord').innerText = me.word;
        const t = document.getElementById('roleTitle'); const d = document.getElementById('roleDesc');
        const sb = document.getElementById('gameStatusHeader');
        
        if(me.alive) { sb.innerText="üü¢ SEI VIVO"; sb.className="status-bar st-alive"; } 
        else { sb.innerText="üî¥ ELIMINATO"; sb.className="status-bar st-dead"; }

        if(me.role==='civil') { t.innerText="CIVILE"; t.className="accent"; d.innerText="Trova l'intruso."; }
        else if(me.role==='undercover') { t.innerText="UNDERCOVER"; t.className="under-role"; d.innerText="Confonditi."; }
        else { t.innerText="MR. WHITE"; t.className="white-role"; d.innerText="Fingi di sapere la parola."; }
    }

    function goToVote() {
        if(isHost) { connections.forEach(c => c.send({t:'VOTE_OPEN', state:gameState})); renderVote(); }
        else showToast("Aspetta l'Host");
    }

    function renderVote() {
        switchView('view-vote');
        const list = document.getElementById('voteList'); list.innerHTML='';
        const me = gameState.players.find(p=>p.id===myId);
        
        if(!me.alive) {
            document.getElementById('voteStatusHeader').className="status-bar st-dead";
            document.getElementById('voteStatusHeader').innerText="üî¥ SPETTATORE";
            document.getElementById('deadMessage').classList.remove('hidden');
        } else {
            document.getElementById('voteStatusHeader').className="status-bar st-alive";
            document.getElementById('voteStatusHeader').innerText="üü¢ VOTAZIONE";
            document.getElementById('deadMessage').classList.add('hidden');
            gameState.players.forEach(p => {
                if(p.alive && p.id!==myId) {
                    const b = document.createElement('button'); b.className='btn-vote';
                    b.innerHTML=`<span>${p.name}</span> <span>‚ò†Ô∏è</span>`;
                    b.onclick = () => {
                        list.innerHTML='<p style="color:#888;">Voto inviato...</p>';
                        if(isHost) { p.votes++; checkRoundEnd(); } else conn.send({t:'VOTE', target:p.id});
                    };
                    list.appendChild(b);
                }
            });
        }
    }

    function renderResult(winTeam, msg, mwCaught) {
        switchView('view-result');
        const me = gameState.players.find(p=>p.id===myId);
        const banner = document.getElementById('personalResultBanner');
        
        document.getElementById('resMsg').innerText = msg;
        document.getElementById('mrWhiteChance').classList.add('hidden');

        if(winTeam === 'PENDING') {
            banner.style.background="#555"; banner.querySelector('h1').innerText="ATTESA"; banner.querySelector('p').innerText="Fase finale...";
            document.getElementById('teamWinnerTitle').innerText = "Mr. White Preso...";
            if(isHost && mwCaught) document.getElementById('mrWhiteChance').classList.remove('hidden');
        } else {
            const iAmBad = (me.role!=='civil');
            const iWon = (winTeam==='CIVILS' && !iAmBad) || (winTeam==='IMPOSTORS' && iAmBad);
            
            banner.className = iWon ? "win-banner" : "lose-banner";
            banner.querySelector('h1').innerText = iWon ? "HAI VINTO! üèÜ" : "HAI PERSO üíÄ";
            banner.querySelector('p').innerText = iWon ? "Ottimo lavoro!" : "Peccato...";
            document.getElementById('teamWinnerTitle').innerText = (winTeam==='CIVILS') ? "Vincono i Civili" : "Vincono gli Impostori";
            
            // Lista Ruoli
            const d = document.getElementById('resDetails'); d.innerHTML='<h4>Ruoli:</h4>';
            gameState.players.forEach(p => {
                let c = p.role==='civil'?'accent':(p.role==='undercover'?'under-role':'white-role');
                d.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; margin-bottom:5px;"><span>${p.name}</span><span class="${c}">${p.role}</span></div>`;
            });
        }
    }

    function resetGame() { gameState.phase='lobby'; gameState.players.forEach(p=>{p.alive=true; p.votes=0; p.role=null;}); showLobby(); sync(); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 3000); }
</script>
</body>
</html>
