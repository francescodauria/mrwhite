<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mr. White Ultimate P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --primary: #00e676; 
            --secondary: #2979ff;
            --danger: #ff5252;
            --bg: #121212; 
            --surface: #1e1e1e; 
            --text: #ffffff; 
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 50px;}
        
        .card { background: var(--surface); padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid #333; position: relative; overflow: hidden; }
        
        h1, h2, h3 { margin-top: 0; font-weight: 700; }
        .accent { color: var(--primary); }
        .white-role { color: var(--danger); }
        .under-role { color: var(--secondary); }
        
        input { box-sizing: border-box; width: 100%; padding: 15px; margin: 8px 0; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 10px; font-size: 18px; text-align: center; }
        input:focus { outline: none; border-color: var(--primary); }
        
        button { width: 100%; padding: 16px; margin-top: 10px; border-radius: 10px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-host { background: var(--primary); color: #000; }
        .btn-join { background: var(--secondary); color: white; }
        .btn-vote { background: #333; border: 1px solid #555; color: white; margin-bottom: 8px; text-align: left; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .btn-vote:hover { border-color: var(--primary); background: #252525; }
        
        .hidden { display: none !important; }
        
        /* Status Bar (Alive/Dead) */
        .status-bar { padding: 8px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; }
        .st-alive { background: rgba(0, 230, 118, 0.2); color: var(--primary); border: 1px solid var(--primary); }
        .st-dead { background: rgba(255, 82, 82, 0.2); color: var(--danger); border: 1px solid var(--danger); }

        /* Contatori Host */
        .counter-box { display: flex; justify-content: space-between; align-items: center; background: #2c2c2c; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .counter-btn { width: 40px; height: 40px; margin: 0; padding: 0; font-size: 24px; line-height: 1; }
        .count-display { font-size: 20px; font-weight: bold; width: 30px; }

        .big-word { font-size: 2.2rem; font-weight: 800; color: var(--primary); margin: 20px 0; padding: 20px; border: 2px dashed #444; border-radius: 10px; background: #1a1a1a; word-break: break-word;}
        
        /* Risultato Personale */
        .win-banner { background: var(--primary); color: black; padding: 20px; margin: -20px -20px 20px -20px; }
        .lose-banner { background: var(--danger); color: white; padding: 20px; margin: -20px -20px 20px -20px; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        .player-list li { background: #252525; margin: 5px 0; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #444; }
        .player-list li.me { border-left-color: var(--primary); }
        
        .dead-player { text-decoration: line-through; opacity: 0.5; }
    </style>
</head>
<body>

<div class="container">
    <h1>üïµÔ∏è Secret Roles</h1>

    <div id="view-login" class="card">
        <h3>Chi sei?</h3>
        <input type="text" id="nickname" placeholder="Il tuo nome">
        <input type="text" id="roomName" placeholder="Nome Stanza (es. CIAO)">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="initHost()" class="btn-host">Crea</button>
            <button onclick="initJoin()" class="btn-join">Entra</button>
        </div>
        <p id="connStatus" style="color: #888; margin-top: 15px; font-size: 0.9em;"></p>
    </div>

    <div id="view-lobby" class="card hidden">
        <h2>Stanza: <span id="lobbyRoomName" class="accent"></span></h2>
        
        <div id="hostConfig" class="hidden" style="border-top: 1px solid #333; border-bottom: 1px solid #333; padding: 10px 0; margin: 15px 0;">
            <h4 style="margin: 0 0 10px 0;">Configurazione Nemici</h4>
            <div class="counter-box">
                <span>üïµÔ∏è Undercover (Spia)</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="counter-btn" onclick="adjustRole('undercover', -1)">-</button>
                    <span id="count-undercover" class="count-display">1</span>
                    <button class="counter-btn" onclick="adjustRole('undercover', 1)">+</button>
                </div>
            </div>
            <div class="counter-box">
                <span>üè≥Ô∏è Mr. White (Senza parola)</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="counter-btn" onclick="adjustRole('mrwhite', -1)">-</button>
                    <span id="count-mrwhite" class="count-display">0</span>
                    <button class="counter-btn" onclick="adjustRole('mrwhite', 1)">+</button>
                </div>
            </div>
        </div>

        <p>Giocatori: <span id="playerCount">0</span></p>
        <ul id="lobbyList" class="player-list" style="padding:0; list-style:none;"></ul>
        
        <div id="hostControls" class="hidden">
            <button onclick="startGame()" class="btn-host">üöÄ INIZIA PARTITA</button>
        </div>
        <p id="waitingMsg" class="hidden">In attesa dell'Host...</p>
    </div>

    <div id="view-game" class="card hidden">
        <div id="gameStatusHeader" class="status-bar st-alive">üü¢ SEI VIVO</div>
        
        <h2>Tocca a te!</h2>
        <p>La tua parola segreta √®:</p>
        <div id="myWord" class="big-word">...</div>
        
        <h3 id="roleTitle">...</h3>
        <p id="roleDesc" style="color:#aaa; font-size: 0.9rem;">...</p>
        
        <hr style="border-color:#333; margin: 20px 0;">
        <button onclick="goToVote()" class="btn-join">Vai al Voto</button>
    </div>

    <div id="view-vote" class="card hidden">
        <div id="voteStatusHeader" class="status-bar st-alive">üü¢ PUOI VOTARE</div>
        <h2>Votazione</h2>
        <p id="voteInstruction">Chi vuoi eliminare?</p>
        
        <div id="deadMessage" class="hidden" style="color: var(--danger); padding: 20px; border: 1px solid var(--danger); border-radius: 10px; margin-bottom: 20px;">
            ‚ò†Ô∏è SEI STATO ELIMINATO<br>
            <span style="font-size:0.8rem; color:#ccc;">Non puoi votare, ma puoi guardare.</span>
        </div>

        <div id="voteList"></div>
    </div>

    <div id="view-result" class="card hidden" style="padding-top:0;">
        <div id="personalResultBanner" class="win-banner">
            <h1 style="margin:0; font-size: 2.5rem;">VITTORIA</h1>
            <p style="margin:5px 0 0 0;">Hai vinto!</p>
        </div>
        
        <h3 id="teamWinnerTitle" style="margin-top:20px;">Vincono i Civili</h3>
        <p id="resMsg" style="font-size: 1em; color:#ccc;">...</p>
        
        <div id="resDetails" style="text-align: left; background: #222; padding: 10px; border-radius: 8px; margin-top: 20px;"></div>
        
        <div id="mrWhiteChance" class="hidden" style="background: #330000; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid red;">
            <h3 style="color:red; margin-top:0;">üò± Mr. White Preso!</h3>
            <p>Se indovina la parola dei Civili, vince lui!</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="mrWhiteWin()" style="background:red; color:white; margin:0;">Ha Indovinato</button>
                <button onclick="civiliansWinFinal()" style="background:#444; margin:0;">Ha Sbagliato</button>
            </div>
        </div>

        <button onclick="resetGame()" class="btn-host">Torna alla Lobby</button>
    </div>
</div>

<div id="toast" class="toast">Notifica</div>

<script>
    // --- CONFIGURAZIONE ---
    const APP_ID = "mrwhite_ultimate_v3_"; 
    const wordsDB = [
        ["Pizza", "Pasta"], ["Cane", "Gatto"], ["Facebook", "Instagram"], 
        ["Sole", "Luna"], ["Vino", "Birra"], ["Mare", "Piscina"],
        ["Sci", "Snowboard"], ["Ketchup", "Maionese"], ["Apple", "Samsung"],
        ["T√®", "Caff√®"], ["Chitarra", "Basso"], ["Harry Potter", "Il Signore degli Anelli"],
        ["Spiderman", "Batman"], ["Hotel", "Campeggio"], ["Aereo", "Elicottero"],
        ["Inverno", "Autunno"], ["Doccia", "Bagno"], ["Whatsapp", "Telegram"],
        ["Cioccolato", "Nutella"], ["Dottore", "Infermiere"]
    ];

    let peer, conn, myId, myName;
    let isHost = false;
    let connections = [];
    
    let config = { undercover: 1, mrwhite: 0 };

    let gameState = {
        players: [], 
        phase: 'lobby',
        secretWordCivil: '',
        secretWordUnder: ''
    };

    /* --- NETWORKING (PEERJS) --- */

    function getCleanRoomId() {
        const val = document.getElementById('roomName').value;
        if(!val) return null;
        return APP_ID + val.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function initHost() {
        const rName = document.getElementById('roomName').value;
        const roomId = getCleanRoomId();
        myName = document.getElementById('nickname').value;
        
        if(!myName || !roomId) return showToast("Dati mancanti");
        document.getElementById('connStatus').innerText = "Creazione...";
        
        peer = new Peer(roomId);

        peer.on('open', id => {
            isHost = true;
            myId = id;
            addPlayer(id, myName);
            showLobby(rName);
            document.getElementById('hostConfig').classList.remove('hidden');
            document.getElementById('hostControls').classList.remove('hidden');
        });

        peer.on('error', err => { alert("Stanza occupata o errore."); });

        peer.on('connection', c => {
            connections.push(c);
            c.on('data', d => handleDataHost(d, c.peer));
            c.on('close', () => removePlayer(c.peer));
        });
    }

    function initJoin() {
        const rName = document.getElementById('roomName').value;
        const roomId = getCleanRoomId();
        myName = document.getElementById('nickname').value;

        if(!myName || !roomId) return showToast("Dati mancanti");
        document.getElementById('connStatus').innerText = "Connessione...";

        peer = new Peer(); 
        peer.on('open', id => {
            myId = id;
            conn = peer.connect(roomId);
            conn.on('open', () => {
                conn.send({ type: 'JOIN', name: myName });
                showLobby(rName);
                document.getElementById('waitingMsg').classList.remove('hidden');
            });
            conn.on('data', d => handleDataClient(d));
            conn.on('close', () => { alert("Host disconnesso"); location.reload(); });
        });
    }

    /* --- GESTIONE DATI --- */

    function handleDataHost(data, senderId) {
        if(data.type === 'JOIN') { addPlayer(senderId, data.name); broadcastState(); }
        if(data.type === 'VOTE') {
            const p = gameState.players.find(x => x.id === data.target);
            if(p) p.votes++;
            checkVotesEnd();
        }
    }

    function handleDataClient(data) {
        if(data.type === 'STATE') { gameState = data.state; renderLobbyList(); }
        if(data.type === 'START') { gameState = data.state; renderGameScreen(); }
        if(data.type === 'VOTE_START') { gameState = data.state; renderVoteScreen(); }
        if(data.type === 'GAME_OVER') { renderResult(data.winnerTeam, data.msg, data.killedRole); }
    }

    /* --- LOGICA GIOCO --- */

    function addPlayer(id, name) {
        if(!gameState.players.find(p => p.id === id)){
            gameState.players.push({ id, name, isAlive: true, votes: 0 });
            renderLobbyList();
        }
    }
    
    function removePlayer(id) {
        gameState.players = gameState.players.filter(p => p.id !== id);
        broadcastState();
        renderLobbyList();
    }

    function adjustRole(role, delta) {
        config[role] += delta;
        if(config[role] < 0) config[role] = 0;
        document.getElementById('count-' + role).innerText = config[role];
    }

    function startGame() {
        const total = gameState.players.length;
        const impostors = config.undercover + config.mrwhite;

        if(total < 3) return showToast("Minimo 3 giocatori!");
        if(impostors >= total) return showToast("Troppi impostori!");
        if(impostors === 0) return showToast("Metti almeno un nemico!");

        const pair = wordsDB[Math.floor(Math.random() * wordsDB.length)];
        gameState.secretWordCivil = pair[0];
        gameState.secretWordUnder = pair[1];

        let deck = [];
        for(let i=0; i<config.undercover; i++) deck.push('undercover');
        for(let i=0; i<config.mrwhite; i++) deck.push('mrwhite');
        while(deck.length < total) deck.push('civil');
        
        // Shuffle
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }

        gameState.players.forEach((p, idx) => {
            p.role = deck[idx];
            p.votes = 0;
            p.isAlive = true;
            p.word = (p.role === 'civil') ? gameState.secretWordCivil : (p.role === 'undercover' ? gameState.secretWordUnder : "???");
        });

        renderGameScreen();
        broadcast({ type: 'START', state: gameState });
    }

    function checkVotesEnd() {
        const living = gameState.players.filter(p => p.isAlive).length;
        const totalVotes = gameState.players.reduce((sum, p) => sum + p.votes, 0);

        if(totalVotes >= living) evaluateRound();
    }

    function evaluateRound() {
        let maxVotes = 0, candidates = [];
        
        gameState.players.forEach(p => {
            if(p.votes > maxVotes) { maxVotes = p.votes; candidates = [p]; } 
            else if (p.votes === maxVotes) candidates.push(p);
        });

        gameState.players.forEach(p => p.votes = 0); // Reset

        if(candidates.length > 1 || maxVotes === 0) {
            broadcast({ type: 'VOTE_START', state: gameState });
            renderVoteScreen();
            return showToast("Pareggio! Si rivota.");
        }

        const eliminated = candidates[0];
        eliminated.isAlive = false;

        // CHECK VITTORIA
        const aliveImpostors = gameState.players.filter(p => p.isAlive && p.role !== 'civil').length;
        const aliveCivils = gameState.players.filter(p => p.isAlive && p.role === 'civil').length;

        if(eliminated.role === 'mrwhite') {
             broadcastResult('PENDING', `Mr. White (${eliminated.name}) preso! Deve indovinare.`, 'mrwhite_caught');
             return;
        }
        if(aliveImpostors === 0) {
            broadcastResult('CIVILS', "Tutti i nemici eliminati!");
            return;
        }
        if(aliveImpostors >= aliveCivils || (aliveImpostors + aliveCivils) <= 2) {
            broadcastResult('IMPOSTORS', "Gli intrusi hanno vinto!");
            return;
        }

        broadcast({ type: 'VOTE_START', state: gameState });
        renderVoteScreen(); 
        showToast(`${eliminated.name} eliminato!`);
    }

    function mrWhiteWin() { broadcastResult("IMPOSTORS", "Mr. White ha indovinato!"); }
    function civiliansWinFinal() {
        const aliveImpostors = gameState.players.filter(p => p.isAlive && p.role !== 'civil').length;
        if(aliveImpostors > 0) {
             broadcast({ type: 'VOTE_START', state: gameState });
             renderVoteScreen();
        } else {
             broadcastResult("CIVILS", "Mr. White ha sbagliato!");
        }
    }

    /* --- UI --- */

    function switchView(id) {
        document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function showLobby(roomName) {
        switchView('view-lobby');
        document.getElementById('lobbyRoomName').innerText = roomName;
        renderLobbyList();
    }

    function renderLobbyList() {
        const list = document.getElementById('lobbyList');
        list.innerHTML = '';
        gameState.players.forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${p.name} ${!p.isAlive ? 'üíÄ' : ''}</span>`;
            if(p.id === myId) li.classList.add('me');
            if(!p.isAlive) li.classList.add('dead-player');
            list.appendChild(li);
        });
        document.getElementById('playerCount').innerText = gameState.players.length;
    }

    function renderGameScreen() {
        switchView('view-game');
        const me = gameState.players.find(p => p.id === myId);
        
        // Status Bar
        const sb = document.getElementById('gameStatusHeader');
        if(me.isAlive) {
            sb.innerText = "üü¢ SEI VIVO";
            sb.className = "status-bar st-alive";
        } else {
            sb.innerText = "üî¥ SEI ELIMINATO";
            sb.className = "status-bar st-dead";
        }

        document.getElementById('myWord').innerText = me.word;
        
        const rt = document.getElementById('roleTitle');
        const rd = document.getElementById('roleDesc');

        if(me.role === 'civil') {
            rt.innerText = "CIVILE"; rt.className = "accent";
            rd.innerText = "Trova l'intruso tra voi.";
        } else if (me.role === 'undercover') {
            rt.innerText = "UNDERCOVER"; rt.className = "under-role";
            rd.innerText = "Hai una parola diversa. Mimetizzati.";
        } else {
            rt.innerText = "MR. WHITE"; rt.className = "white-role";
            rd.innerText = "Non hai parola. Ascolta e fingi.";
        }
    }

    function goToVote() {
        if(isHost) {
            broadcast({ type: 'VOTE_START', state: gameState });
            renderVoteScreen();
        } else showToast("Aspetta l'Host");
    }

    function renderVoteScreen() {
        switchView('view-vote');
        const list = document.getElementById('voteList');
        const deadMsg = document.getElementById('deadMessage');
        const statusHeader = document.getElementById('voteStatusHeader');
        list.innerHTML = '';

        const me = gameState.players.find(p => p.id === myId);

        if(!me.isAlive) {
            // SE SEI MORTO
            statusHeader.innerText = "üî¥ SEI ELIMINATO";
            statusHeader.className = "status-bar st-dead";
            deadMsg.classList.remove('hidden');
            list.classList.add('hidden'); // Nascondi bottoni voto
        } else {
            // SE SEI VIVO
            statusHeader.innerText = "üü¢ TOCCA A TE";
            statusHeader.className = "status-bar st-alive";
            deadMsg.classList.add('hidden');
            list.classList.remove('hidden');

            gameState.players.forEach(p => {
                if(p.isAlive && p.id !== myId) {
                    const btn = document.createElement('button');
                    btn.className = 'btn-vote';
                    btn.innerHTML = `<span>${p.name}</span> <span>‚ò†Ô∏è</span>`;
                    btn.onclick = () => {
                        list.innerHTML = '<p style="text-align:center; color:#888;">Voto inviato...</p>';
                        if(isHost) {
                            p.votes++;
                            checkVotesEnd();
                        } else conn.send({ type: 'VOTE', target: p.id });
                    };
                    list.appendChild(btn);
                }
            });
        }
    }

    function renderResult(winnerTeam, msg, killedRole) {
        switchView('view-result');
        const me = gameState.players.find(p => p.id === myId);
        
        // Logica Messaggio Personale
        const banner = document.getElementById('personalResultBanner');
        const h1 = banner.querySelector('h1');
        const p = banner.querySelector('p');
        
        let iWon = false;
        const iAmBad = (me.role === 'undercover' || me.role === 'mrwhite');

        if(winnerTeam === 'PENDING') {
            banner.className = "win-banner"; // Neutro
            banner.style.background = "#555";
            banner.style.color = "white";
            h1.innerText = "ATTESA";
            p.innerText = "Mr. White sta provando a indovinare...";
        } else {
            if(winnerTeam === 'CIVILS' && !iAmBad) iWon = true;
            else if(winnerTeam === 'IMPOSTORS' && iAmBad) iWon = true;
            
            if(iWon) {
                banner.className = "win-banner";
                h1.innerText = "HAI VINTO! üèÜ";
                p.innerText = "La tua squadra ha trionfato.";
            } else {
                banner.className = "lose-banner";
                h1.innerText = "HAI PERSO üíÄ";
                p.innerText = "Ritenta la prossima volta.";
            }
        }

        // Dettagli Generali
        document.getElementById('teamWinnerTitle').innerText = 
            winnerTeam === 'PENDING' ? "..." : (winnerTeam === 'CIVILS' ? "Vincono i Civili" : "Vincono gli Impostori");
        document.getElementById('resMsg').innerText = msg;

        // Lista Ruoli
        const det = document.getElementById('resDetails');
        det.innerHTML = '<h4>Ruoli Rivelati:</h4>';
        gameState.players.forEach(p => {
            let roleName = p.role === 'civil' ? 'Civile' : (p.role === 'undercover' ? 'Undercover' : 'Mr. White');
            let colorClass = p.role === 'civil' ? 'accent' : (p.role === 'undercover' ? 'under-role' : 'white-role');
            det.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #333;">
                <span class="${!p.isAlive ? 'dead' : ''}">${p.name}</span>
                <span class="${colorClass}">${roleName}</span>
            </div>`;
        });

        // Chance Mr White (Solo Host)
        const mwBox = document.getElementById('mrWhiteChance');
        if(isHost && killedRole === 'mrwhite_caught') mwBox.classList.remove('hidden');
        else mwBox.classList.add('hidden');
    }

    function broadcast(data) { connections.forEach(c => c.send(data)); }
    function broadcastState() { broadcast({ type: 'STATE', state: gameState }); }
    function broadcastResult(winnerTeam, msg, killedRole=null) {
        renderResult(winnerTeam, msg, killedRole);
        broadcast({ type: 'GAME_OVER', winnerTeam, msg, killedRole });
    }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(()=>t.style.opacity=0, 3000);
    }
    function resetGame() {
        gameState.phase = 'lobby';
        gameState.players.forEach(p => { p.isAlive = true; p.votes = 0; p.role = null; });
        showLobby(document.getElementById('roomName').value);
        broadcastState();
    }
</script>
</body>
</html>
